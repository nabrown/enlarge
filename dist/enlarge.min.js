/*! fg-enlarge - v0.3.1 - 2018-08-18
* Copyright (c) 2018 Scott Jehl, Filament Group, Inc.; Licensed MIT */

!function(S){var t,a,e=window.navigator&&window.navigator.msPointerEnabled&&window.MSGesture,n="ontouchstart"in window||e||window.DocumentTouch&&document instanceof DocumentTouch;a={hoverZoomWithoutClick:!1,delay:200,flyout:{width:"300px",height:"300px"},placement:"flyoutloupe",magnification:5},t={hoverZoomWithoutClick:!0,delay:500,flyout:{width:"300px",height:"300px"},placement:"flyoutright",magnification:3};var i=function(){var Q=S.jQuery,R="enlarge";Q.fn[R]=function(){var N,j=arguments,F=Q(this).data("options");"string"!=typeof F&&(o=n?Q.extend({},a,F.touchOptions):Q.extend({},t,F),Q(this).data("options",o));var e=this.each(function(){var a=Q(this),n=this,e=S.document.createElement("img"),i="srcset"in e&&"sizes"in e,t=Q(this).find("a");if(!t.length)throw new Error(R+": requires an anchor element with `href` for the enlarged image source");var h,g,d=a.find("img")[0],p=d,s=p.src,r=Q(p).attr("srcset"),l=Q(p).attr("sizes"),c=t[0].href,m=(t[0].innerText,R+"-zoomed"),u=R+"-delay",v=Q(p).closest(".enlarge_contain"),k=v,f=Q(p).closest(".enlarge_pane")||a,y=Q(this).data("zoomParent")||f;Q(this).data("zoomParent",y);var w=a.data("zoomed")||!1;a.data("zoomed",w),a.data("lockedZoom",a.data("lockedZoom")||!1);var b=R+"-locked";if(!v.length)throw new Error(R+": requires an element above the image marked with the class `enlarge_contain`");if("string"!=typeof F){var z,C,x,Z;E(),a.data("updateOptions",function(e){o=Q.extend(o,e),Q(this).data("options",o),P(),T(),W=o.hoverZoomWithoutClick,o.image&&o.image.sizes&&(l=o.image.sizes,A()),E(),o.disabled&&a.data("zoomed")&&I()});var W=o.hoverZoomWithoutClick,_=Q('<div class="enlarge_flyout"></div>').append(v.clone());_.insertAfter(f),P(),T(),t.bind("keydown",function(e){var t;13!==e.keyCode&&32!==e.keyCode||"inline"!==(t=o.placement)&&(Q(n).bind(R+".after-zoom-out",function e(){o.placement=t,P(),Q(n).unbind(R+".after-zoom-out",e)}),o.placement="inline",P()),32===e.keyCode&&(e.preventDefault(),Q(this).trigger("click"))}).bind("click",function(e){e.preventDefault(),I()}),Q(S).bind("resize",function(e){a.data("lockedZoom")&&I()}),Q(S.document).bind("mouseup",function(e){a.data("lockedZoom")&&!Q(e.target).closest(f).length&&I()}),Q(d).bind("mouseenter touchstart",function(e){v.append('<div class="enlarge_loader"><div>Loading detail...</div></div>'),"touchstart"===e.type&&(Z=!0),Z&&"mouseenter"===e.type||"mouseenter"===e.type&&!Z&&!W||a.data("lockedZoom")||x||(x=!0,v.addClass(u),C=setTimeout(function(){v.removeClass(u),O(),A(function(){B(),z=!0,L(e)})},o.delay))}).bind("mousemove touchmove",L).bind("mouseleave touchend",function(e){var t;x=!1,w&&!a.data("lockedZoom")&&(O(),A(function(){B()})),t=e,v.removeClass(u),clearTimeout(C),(z=!1)!==o.hoverZoomWithoutClick||Z||(W=!1),Z&&"mouseleave"===t.type&&(Z=!1)}).bind("click",function(e){e.preventDefault(),Z&&"inline"===o.placement&&I(),!1!==o.hoverZoomWithoutClick||Z||((W=!W)?Q(this).trigger("mouseenter"):Q(this).trigger("mouseleave"))}),Q(this).bind("keydown keyup",function(e){37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode?(e.stopImmediatePropagation(),a.data("lockedZoom")||e.preventDefault()):"keyup"===e.type&&Q(this).data("lockedZoom")&&27===e.keyCode&&(I(),t[0].focus(),e.stopImmediatePropagation())}),f.bind("scroll",function(){a.data("zoomed")&&(O(),A(function(){a.data("lockedZoom")&&H(),B()}))})}else{var D=Array.prototype.slice.call(j,1);switch(F){case"in":a.data("zoomed")||I();break;case"out":a.data("zoomed")&&I();break;case"isZoomed":N=a.data("zoomed");break;case"updateOptions":a.data("updateOptions")(D[0])}}function P(){"inline"===o.placement?(p=d,y=f,a.data("zoomParent",y),k=v):(p=_.find("img")[0],y=k=_,a.data("zoomParent",y))}function T(){_.css({width:o.flyout.width,height:o.flyout.height,top:"",left:"","margin-left":"","margin-top":""}),console.log(_.width()),console.log(_.height()),h=_.width(),g=_.height();var e=o.placement.match(/left|right/);e&&(_.css(e[0],-h-10+"px"),_.css("top","0")),o.placement.match(/loupe/)&&_.css({"margin-left":-h/2+"px","margin-top":-g/2+"px"}),_[0].className=_[0].className.replace(/enlarge_flyout\-[^$\s]+/," "),_.addClass("enlarge_flyout-"+o.placement)}function E(){o.disabled?a.addClass("enlarge_disabled"):a.removeClass("enlarge_disabled")}function O(){w=!a.data("zoomed"),a.data("zoomed",w)}function A(t){if(t=t||function(){},w){if(o.disabled)return t(),!1;var a=new Image;a.className="enlarge_img-loading",a.onload=function(){var e;p.sizes=a.sizes,i&&r||(p.src=c),Q(a).remove(),(e=v.find(".enlarge_loader")).on("animationend",function(){e.remove()}),e.addClass("fadeOut"),t()},a.sizes=q()+"px",i&&r?r&&(a.srcset=r):a.src=c,console.log("zoom image insterted"),Q(a).insertBefore(p)}else p.sizes=l,i||(p.src=s),t()}function H(){if(a.data("lockedZoom"))f.add(y).removeClass(b),a.data("lockedZoom",lockedZoom=!1),k.removeAttr("tabindex");else{if(o.disabled)return!1;f.add(y).addClass(b),a.data("lockedZoom",lockedZoom=!0),k.attr("tabindex","0"),k[0].focus()}}function q(){return f[0].offsetWidth*o.magnification}function B(){if(a.data("zoomed")){if(o.disabled)return!1;"inline"===o.placement&&v.add(f).css({width:f[0].offsetWidth+"px",height:parseFloat(getComputedStyle(f[0]).height)+"px"}),y.addClass(m),Q(p).css("width",q()+"px"),Q(n).trigger(R+".after-zoom-in")}else y.removeClass(m),"inline"===o.placement&&v.add(f).css({width:"",height:""}),Q(p).css("width",""),Q(n).trigger(R+".after-zoom-out")}function I(){if(o.disabled&&!a.data("zoomed"))return!1;O(),A(function(){var e,o,t,a;H(),B(),e=k.width(),o=k.height(),t=p.offsetWidth,a=p.offsetHeight,k[0].scrollLeft=t/2-e/2,k[0].scrollTop=a/2-o/2})}function L(e){if(z){if(Z&&"mousemove"===e.type)return;var t=e.originalEvent||e,a=t.touches?t.touches[0]:t;e.preventDefault();var n=a.clientX-v[0].getBoundingClientRect().left,i=a.clientY-v[0].getBoundingClientRect().top;if(o.placement.match(/loupe/)){var d=(t.touches?-h/1.3:-h/2)+"px",s=(t.touches?-g/1.3:-g/2)+"px";requestAnimationFrame(function(){_.css({top:i+"px",left:n+"px","margin-left":d,"margin-top":s})})}var r=v[0].offsetWidth,l=v[0].offsetHeight,c=p.offsetWidth,m=p.offsetHeight,u=k[0].offsetWidth,f=k[0].offsetHeight;k[0].scrollLeft=n/r*(c-u),k[0].scrollTop=i/l*(m-f)}}});return void 0!==N?N:e}};"undefined"!=typeof module?module.exports=i:i()}("undefined"!=typeof global?global:this),function(o,e,t){var a="enlarge";o(document).bind("enhance",function(e){o(".enlarge",e.target)[a]()})}(jQuery);