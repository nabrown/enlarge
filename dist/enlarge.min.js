/*! fg-enlarge - v0.3.1 - 2018-08-18
* Copyright (c) 2018 Scott Jehl, Filament Group, Inc.; Licensed MIT */

!function(Q){var t,a,e=window.navigator&&window.navigator.msPointerEnabled&&window.MSGesture,i="ontouchstart"in window||e||window.DocumentTouch&&document instanceof DocumentTouch;a={hoverZoomWithoutClick:!1,delay:200,flyout:{width:300,height:300},placement:"flyoutloupe",magnification:5},t={hoverZoomWithoutClick:!0,delay:1e3,flyout:{width:300,height:300},placement:"flyoutright",magnification:3};var n=function(){var j=Q.jQuery,F="enlarge";j.fn[F]=function(){var I,L=arguments,N=j(this).data("options");"string"!=typeof N&&(o=i?j.extend({},a,N.touchOptions):j.extend({},t,N),j(this).data("options",o));var e=this.each(function(){var a=j(this),i=this,e=Q.document.createElement("img"),n="srcset"in e&&"sizes"in e,t=j(this).find("a");if(!t.length)throw new Error(F+": requires an anchor element with `href` for the enlarged image source");var d=a.find("img")[0],h=d,s=h.src,r=j(h).attr("srcset"),l=j(h).attr("sizes"),c=t[0].href,u=(t[0].innerText,F+"-zoomed"),f=F+"-delay",g=j(h).closest(".enlarge_contain"),p=g,m=j(h).closest(".enlarge_pane")||a,v=j(this).data("zoomParent")||m;j(this).data("zoomParent",v);var y=a.data("zoomed")||!1;a.data("zoomed",y),a.data("lockedZoom",a.data("lockedZoom")||!1);var k=F+"-locked";if(!g.length)throw new Error(F+": requires an element above the image marked with the class `enlarge_contain`");if("string"!=typeof N){var w,b,z,C;P(),a.data("updateOptions",function(e){o=j.extend(o,e),j(this).data("options",o),_(),D(),Z=o.hoverZoomWithoutClick,o.image&&o.image.sizes&&(l=o.image.sizes,E()),P(),o.disabled&&a.data("zoomed")&&q()});var Z=o.hoverZoomWithoutClick,x=j('<div class="enlarge_flyout"></div>').append(g.clone());x.insertAfter(m),_(),D(),t.bind("keydown",function(e){var t;13!==e.keyCode&&32!==e.keyCode||"inline"!==(t=o.placement)&&(j(i).bind(F+".after-zoom-out",function e(){o.placement=t,_(),j(i).unbind(F+".after-zoom-out",e)}),o.placement="inline",_()),32===e.keyCode&&(e.preventDefault(),j(this).trigger("click"))}).bind("click",function(e){e.preventDefault(),q()}),j(Q).bind("resize",function(e){a.data("lockedZoom")&&q()}),j(Q.document).bind("mouseup",function(e){a.data("lockedZoom")&&!j(e.target).closest(m).length&&q()}),j(d).bind("mouseenter touchstart",function(e){g.append('<div class="enlarge_loader"><div>Loading detail...</div></div>'),"touchstart"===e.type&&(C=!0),C&&"mouseenter"===e.type||"mouseenter"===e.type&&!C&&!Z||a.data("lockedZoom")||z||(z=!0,g.addClass(f),b=setTimeout(function(){g.removeClass(f),T(),E(function(){H(),w=!0,B(e)})},o.delay))}).bind("mousemove touchmove",B).bind("mouseleave touchend",function(e){var t;z=!1,y&&!a.data("lockedZoom")&&(T(),E(function(){H()})),t=e,g.removeClass(f),clearTimeout(b),(w=!1)!==o.hoverZoomWithoutClick||C||(Z=!1),C&&"mouseleave"===t.type&&(C=!1)}).bind("click",function(e){e.preventDefault(),C&&"inline"===o.placement&&q(),!1!==o.hoverZoomWithoutClick||C||((Z=!Z)?j(this).trigger("mouseenter"):j(this).trigger("mouseleave"))}),j(this).bind("keydown keyup",function(e){37===e.keyCode||38===e.keyCode||39===e.keyCode||40===e.keyCode?(e.stopImmediatePropagation(),a.data("lockedZoom")||e.preventDefault()):"keyup"===e.type&&j(this).data("lockedZoom")&&27===e.keyCode&&(q(),t[0].focus(),e.stopImmediatePropagation())}),m.bind("scroll",function(){a.data("zoomed")&&(T(),E(function(){a.data("lockedZoom")&&O(),H()}))})}else{var W=Array.prototype.slice.call(L,1);switch(N){case"in":a.data("zoomed")||q();break;case"out":a.data("zoomed")&&q();break;case"isZoomed":I=a.data("zoomed");break;case"updateOptions":a.data("updateOptions")(W[0])}}function _(){"inline"===o.placement?(h=d,v=m,a.data("zoomParent",v),p=g):(h=x.find("img")[0],v=p=x,a.data("zoomParent",v))}function D(){x.css({width:o.flyout.width+"px",height:o.flyout.height+"px",top:"",left:"","margin-left":"","margin-top":""});var e=o.placement.match(/left|right/);e&&(x.css(e[0],-o.flyout.width-10+"px"),x.css("top","0")),o.placement.match(/loupe/)&&x.css({"margin-left":-o.flyout.width/2+"px","margin-top":-o.flyout.height/2+"px"}),x[0].className=x[0].className.replace(/enlarge_flyout\-[^$\s]+/," "),x.addClass("enlarge_flyout-"+o.placement)}function P(){o.disabled?a.addClass("enlarge_disabled"):a.removeClass("enlarge_disabled")}function T(){y=!a.data("zoomed"),a.data("zoomed",y)}function E(t){if(t=t||function(){},y){if(o.disabled)return t(),!1;var a=new Image;a.className="enlarge_img-loading",a.onload=function(){var e;h.sizes=a.sizes,n&&r||(h.src=c),j(a).remove(),(e=g.find(".enlarge_loader")).on("animationend",function(){e.remove()}),e.addClass("fadeOut"),t()},a.sizes=A()+"px",n&&r?r&&(a.srcset=r):a.src=c,console.log("zoom image insterted"),j(a).insertBefore(h)}else h.sizes=l,n||(h.src=s),t()}function O(){if(a.data("lockedZoom"))m.add(v).removeClass(k),a.data("lockedZoom",lockedZoom=!1),p.removeAttr("tabindex");else{if(o.disabled)return!1;m.add(v).addClass(k),a.data("lockedZoom",lockedZoom=!0),p.attr("tabindex","0"),p[0].focus()}}function A(){return m[0].offsetWidth*o.magnification}function H(){if(a.data("zoomed")){if(o.disabled)return!1;"inline"===o.placement&&g.add(m).css({width:m[0].offsetWidth+"px",height:parseFloat(getComputedStyle(m[0]).height)+"px"}),v.addClass(u),j(h).css("width",A()+"px"),j(i).trigger(F+".after-zoom-in")}else v.removeClass(u),"inline"===o.placement&&g.add(m).css({width:"",height:""}),j(h).css("width",""),j(i).trigger(F+".after-zoom-out")}function q(){if(o.disabled&&!a.data("zoomed"))return!1;T(),E(function(){var e,o,t,a;O(),H(),e=p.width(),o=p.height(),t=h.offsetWidth,a=h.offsetHeight,p[0].scrollLeft=t/2-e/2,p[0].scrollTop=a/2-o/2})}function B(e){if(w){if(C&&"mousemove"===e.type)return;var t=e.originalEvent||e,a=t.touches?t.touches[0]:t;e.preventDefault();var i=a.clientX-g[0].getBoundingClientRect().left,n=a.clientY-g[0].getBoundingClientRect().top;if(o.placement.match(/loupe/)){var d=(t.touches?-o.flyout.width/1.3:-o.flyout.width/2)+"px",s=(t.touches?-o.flyout.height/1.3:-o.flyout.height/2)+"px";requestAnimationFrame(function(){x.css({top:n+"px",left:i+"px","margin-left":d,"margin-top":s})})}var r=g[0].offsetWidth,l=g[0].offsetHeight,c=h.offsetWidth,u=h.offsetHeight,f=p[0].offsetWidth,m=p[0].offsetHeight;p[0].scrollLeft=i/r*(c-f),p[0].scrollTop=n/l*(u-m)}}});return void 0!==I?I:e}};"undefined"!=typeof module?module.exports=n:n()}("undefined"!=typeof global?global:this),function(o,e,t){var a="enlarge";o(document).bind("enhance",function(e){o(".enlarge",e.target)[a]()})}(jQuery);